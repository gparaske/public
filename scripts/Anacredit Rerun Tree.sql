--Τρέχουμε τα παρακάτω truncates και στην συνέχεια κατεβάζουμε από παραγωγή τους πίνακες Anacredit.src και τον ctrl.ETL_RUN
TRUNCATE TABLE Anacredit.ctrl.ETL_RUN
TRUNCATE TABLE Anacredit.src.EDW_acc_ACC
TRUNCATE TABLE Anacredit.src.EDW_ACC_ACC_LOAN_SUPPL_RISK
TRUNCATE TABLE Anacredit.src.EDW_acc_ACC_SRGT
TRUNCATE TABLE Anacredit.src.EDW_ACC_ACC_SUPPL_FIN
TRUNCATE TABLE Anacredit.src.EDW_acc_ACC_X_ACC
TRUNCATE TABLE Anacredit.src.EDW_acc_CR_LINE_LMT
TRUNCATE TABLE Anacredit.src.EDW_appl_APPL
TRUNCATE TABLE Anacredit.src.EDW_appl_APPL_X_CST
TRUNCATE TABLE Anacredit.src.EDW_appr_APPR
TRUNCATE TABLE Anacredit.src.EDW_appr_APPR_X_ACC
TRUNCATE TABLE Anacredit.src.EDW_appr_APPR_X_RESCHDL
TRUNCATE TABLE Anacredit.src.EDW_bkrpt_BKRPT_LEGAL_PROTECTION
TRUNCATE TABLE Anacredit.src.EDW_cnt_ACC_X_CNT
TRUNCATE TABLE Anacredit.src.EDW_cnt_CNT_MAIN
TRUNCATE TABLE Anacredit.src.EDW_cnt_CNT_SRGT
TRUNCATE TABLE Anacredit.src.EDW_cnt_CNT_SUPPL
TRUNCATE TABLE Anacredit.src.EDW_cnt_CNT_X_CST
TRUNCATE TABLE Anacredit.src.EDW_coll_COLL_ACC_ALLOCATION
TRUNCATE TABLE Anacredit.src.EDW_coll_COLL_D
TRUNCATE TABLE Anacredit.src.EDW_coll_COLL_GRNT_PRSNL
TRUNCATE TABLE Anacredit.src.EDW_COLL_COLL_M
TRUNCATE TABLE Anacredit.src.EDW_COLL_COLL_PLDG_DEP
TRUNCATE TABLE Anacredit.src.EDW_COLL_COLL_PLDG_SCZ
TRUNCATE TABLE Anacredit.src.EDW_coll_COLL_PRV_WGHT
TRUNCATE TABLE Anacredit.src.EDW_coll_COLL_SRGT
TRUNCATE TABLE Anacredit.src.EDW_coll_COLL_X_VAL_M
TRUNCATE TABLE Anacredit.src.EDW_COLL_CST_X_COLL
TRUNCATE TABLE Anacredit.src.EDW_coll_REAL_EST
TRUNCATE TABLE Anacredit.src.EDW_coll_REAL_EST_ADDR
TRUNCATE TABLE Anacredit.src.EDW_COLL_REAL_EST_WGHT
TRUNCATE TABLE Anacredit.src.EDW_COLL_SHIP_AIR_WGHT
TRUNCATE TABLE Anacredit.src.EDW_com_BIC_DIRECTORY
TRUNCATE TABLE Anacredit.src.EDW_com_FX_RATES
TRUNCATE TABLE Anacredit.src.EDW_com_PRD
TRUNCATE TABLE Anacredit.src.EDW_CST_CST
TRUNCATE TABLE Anacredit.src.EDW_CST_CST_DOC
TRUNCATE TABLE Anacredit.src.EDW_CST_CST_MERGED
TRUNCATE TABLE Anacredit.src.EDW_CST_CST_MIGR
TRUNCATE TABLE Anacredit.src.EDW_cst_CST_ORG
TRUNCATE TABLE Anacredit.src.EDW_CST_CST_PHY_ADDR
TRUNCATE TABLE Anacredit.src.EDW_cst_CST_SUPPL_RISK
TRUNCATE TABLE Anacredit.src.EDW_CST_CST_X_ACC
TRUNCATE TABLE Anacredit.src.EDW_CST_CST_X_CST
TRUNCATE TABLE Anacredit.src.EDW_CST_ORG_CALC_FIN_RATIO
TRUNCATE TABLE Anacredit.src.EDW_CST_ORG_CST_DT
TRUNCATE TABLE Anacredit.src.EDW_CST_ORG_FIN_STMNT
TRUNCATE TABLE Anacredit.src.EDW_CST_ORG_FIN_STMNT_DTLS
TRUNCATE TABLE Anacredit.src.EDW_CST_ORG_FIN_STMNT_HIST
TRUNCATE TABLE Anacredit.src.EDW_CST_ORG_FIN_STMNT_HIST_DTLS
TRUNCATE TABLE Anacredit.src.EDW_ctrl_PARALIST_MAP
TRUNCATE TABLE Anacredit.src.EDW_DEP_ACC_DEP_ACCR
TRUNCATE TABLE Anacredit.src.EDW_DEP_ACC_DEP_BAL
TRUNCATE TABLE Anacredit.src.EDW_DEP_ACC_DEP_RATES
TRUNCATE TABLE Anacredit.src.EDW_la_RETAIL_COLL
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_COFNC
TRUNCATE TABLE Anacredit.src.EDW_LEND_ACC_DPD_DLQ_SMY_M
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_GRC_PER
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN_BAL_EOD
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN_EARTH_SUPPL_FIN
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN_FUT_RATES
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN_PAY_PLAN
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN_RATES
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN_SCRZ
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_LOAN_TRN_MASTER
TRUNCATE TABLE Anacredit.src.EDW_lend_ACC_PROV
TRUNCATE TABLE Anacredit.src.EDW_lend_ACCRUALS
TRUNCATE TABLE Anacredit.src.EDW_smt_DET_LGL_ACT_DNC
TRUNCATE TABLE Anacredit.src.EDW_smt_LGL_ACT_TP_DNC
TRUNCATE TABLE Anacredit.src.FILE_ACCMIMP_DOY
TRUNCATE TABLE Anacredit.src.FILE_BLOOMBERG_PER
TRUNCATE TABLE Anacredit.src.FILE_BLOOMBERG_TMP
TRUNCATE TABLE Anacredit.src.FILE_LOANDEPO_FBL
TRUNCATE TABLE Anacredit.src.FILE_NOSTRO_BALANCES
TRUNCATE TABLE Anacredit.src.FILE_RCO_FBL_GB
TRUNCATE TABLE Anacredit.src.FILE_T_CDR_FBL
TRUNCATE TABLE Anacredit.src.FILE_TREASURY_PRTF
TRUNCATE TABLE Anacredit.src.TREASURY_OUTAM
TRUNCATE TABLE Anacredit.dbo.SPRT_CST_ADD
--Στην συνέχεια αλλάζουμε το Buffer_ANAPMXXX.dtsConfig και βάζουμε την ημερομηνία που θέλουμε να τρέξει, π.χ. 2024-01-31 (\\w000010766\winsched\ana\packages\Buffer_ANAPMXXX.dtsConfig)
--και κάνουμε delete όσες εγγραφές δεν θέλουμε να υπάρχουν άρα για 2024-01-31
DELETE [Anacredit].[ctrl].[ETL_RUN] WHERE REF_DT >= '2023-12-31'
--Άρα η ημερομηνία που περιμένουμε να τρέξει είναι η:
SELECT [REF_DT] FROM [Anacredit].[ctrl].[ETL_REF_DATE] WHERE ETL_JOB_NAME ='ANACRD_L_src_FILE_RCO_FBL_GB_M'
--Με ένα search στα *.bat του \\w000010766\winsched\ANA\ με ".dtsConfig" επιβεβαίωνουμε ότι για το EDW χρησιμοποιεί το EDW_UAT.dtsConfig (δηλαδή w000010766\edw;EDW_UAT)

--Για ταχύτητα έχουν γίνει replace όλα τα bat που κάνουν LOAD (εφόσον αρχικά τα κάνουμε μεταφορά με το χέρι). Έχουν γίνει replace με τα C:\apps\anacredit\ALL_ANA_SRC_LOADS\DEACTIVE
--Αν θέλουμε να τρέξουν κανονικά τα LOAD τότε κάνουμε replace με τα C:\apps\anacredit\ALL_ANA_SRC_LOADS\ACTIVE

--Μπορείς να κάνεις όσα reruns θες αρκεί το αρχείο Buffer_ANAPMXXX.dtsConfig να έχει σωστή batch date. Δεν χρειάζεται κανένα delete ή οτιδήποτε άλλο.






--ΠΑΛΙΕΣ ΟΔΗΓΙΕΣ:
SELECT TOP 10 * FROM Anacredit.DBO.IFD_SUB WHERE REF_DT='2023-11-30' AND OBS_A_ID='GR011' 
--AND INSTST='3'
AND INSID='4207867600IRL'
--Run 1
--Αρχικά πειράζουμε το \\w000010766\winsched\ANA\Packages\Buffer_ANAPMXXX.dtsConfig και βάζουμε την ημερομηνία που θέλουμε να τρέξει

--Μετά δίνουμε τον φάκελο ANAVA01 από το UAT του ControlM

--Μεταφέρουμε το [ctrl].[ETL_RUN] από παραγωγή ώστε μόλις η ANAPVA01 σβίσει τα επόμενα από την ημ/νια που θέλουμε, να μείνει αυτή που θέλουμε.
--Μετά τρέχει το ANAPVA01;\\S000013845\WINSCHED\ANA\ANAPVA01\A01_ANA_RUN_PHASE1.bat;A01_ANA_RUN_PHASE1.dtsx
--Αν π.χ. θέλουμε να τρέξουμε την 2023-04-30 τότε πρέπει να την κάνουμε delete με το script: delete Anacredit.ctrl.ETL_RUN where REF_DT >= '2023-04-30'
SELECT * FROM 
--delete 
[Anacredit].[ctrl].[ETL_RUN]
WHERE REF_DT >= '2023-12-31' --and RUN_STATUS = 'STARTED'
--AND ETL_JOB_NAME LIKE '%ANACRD_T_Anacredit_stg_CRD_TMP_M%'--αν θες να σβίσεις συγκεκριμένο job ώστε να το ξανατρέξεις ενώ το RUN2 έχει ήδη τελειώσει
AND ETL_JOB_NAME LIKE '%ANACRD_T_ANACREDIT_STG_IFD_IRL_M%'--ANAPV320 

select top 10 * from anacredit.[stg].[IFD_Nostro] where OUTAM<>opb

SELECT count(*), REF_DT FROM 
--delete 
[Anacredit].[ctrl].[ETL_RUN]
WHERE REF_DT >= '2023-12-31' --and RUN_STATUS = 'STARTED'
group by REF_DT






DECLARE @batchdate varchar(10)= '2022-06-30' ;
DECLARE @ReportingDate DATE;
DECLARE @RunID INT;
SET @ReportingDate = 
CASE WHEN  @batchdate = '0000-00-00' 
	THEN CAST( DATEADD(DAY, -DAY(GETDATE()), DATEADD(MONTH, 0, GETDATE())) as date)
			ELSE @batchdate 
            end ;
SET @RunID = 1;
SELECT  @ReportingDate ReportingDate ,@RunID  RunID; 
--ReportingDate	RunID
--2022-06-30	1
--Δημιουργεί την A01_ANA_RUN_PHASE1, RunID 0, STARTED/FINISHED και σβίνει όλες τις εγγραφές από το [ctrl].[ETL_RUN] και τους πίνακες dbo.* 
--(όχι τους src.*) οι src.* πίνακες γεμίζουν από το container LOAD tables και μετά το πρώτο run μπορούμε να τους κάνουμε disable
--Σε κάποιες περιπτώσεις μπορεί να θέλουμε να κάνουν load από τον παραγωγικό server αντί του UAT. Πάμε στα bat και βάζουμε το EDW_PROD.dtsConfig
--στην θέση του EDW.dtsConfig
--Μπορείς να κάνεις όσα reruns θες αρκεί το αρχείο Buffer_ANAPMXXX.dtsConfig να έχει σωστή batch date. Δεν χρειάζεται κανένα delete ή οτιδήποτε άλλο.

--Run 2
--Στο run 2 μου έδωσε ο Μιχάλης την παρακάτω λίστα και μου είπε να τα κάνω disable γιατί δεν χρειάζονται. 
--Στην επόμενη φορά μπορώ να τον ρωτήσω για επιβεβαίωση.
--ANAPV338	ANACRD_E_DELTA_EO_AD_SUB_RUN2_M.dtsx
--ANAPV339	ANACRD_E_DELTA_EO_CID_SUB_RUN2_M.dtsx
--ANAPV340	ANACRD_E_DELTA_EO_CRD_SUB_RUN2_M.dtsx
--ANAPV341	ANACRD_E_DELTA_EO_CRID_SUB_RN2_M.dtsx
--ANAPV342	ANACRD_E_DELTA_EO_IFD_SUB_RN2_M.dtsx
--ANAPV343	ANACRD_E_DELTA_EO_IPRD_SUB_RN2_M.dtsx
--ANAPV344	ANACRD_E_DELTA_EO_JLD_SUB_RN2_M.dtsx
--ANAPV345	ANACRD_E_DELTA_EO_PRD_SUB_RN2_M.dtsx
--ANAPV346	ANACRD_E_NEW_EO_AD_SUB_RUN2_M.dtsx
--ANAPV347	ANACRD_E_NEW_EO_CID_SUB_RUN2_M.dtsx
--ANAPV348	ANACRD_E_NEW_EO_CRD_SUB_RUN2_M.dtsx
--ANAPV349	ANACRD_E_NEW_EO_CRID_SUB_RUN2_M.dtsx
--ANAPV350	ANACRD_E_NEW_EO_IFD_SUB_RUN2_M.dtsx
--ANAPV351	ANACRD_E_NEW_EO_IPRD_SUB_RUN2_M.dtsx
--ANAPV352	ANACRD_E_NEW_EO_JLD_SUB_RUN2_M.dtsx
--ANAPV353	ANACRD_E_NEW_EO_PRD_SUB_RUN2_M.dtsx
--ANAPV439	ANACRD_E_FULL_EO_AD_SUB_M.dtsx
--ANAPV440	ANACRD_E_FULL_EO_CID_SUB_M.dtsx
--ANAPV441	ANACRD_E_FULL_EO_CRD_SUB_M.dtsx
--ANAPV442	ANACRD_E_FULL_EO_CRID_SUB_M.dtsx
--ANAPV443	ANACRD_E_FULL_EO_IFD_SUB_M.dtsx
--ANAPV444	ANACRD_E_FULL_EO_IPRD_SUB_M.dtsx
--ANAPV445	ANACRD_E_FULL_EO_JLD_SUB_M.dtsx
--ANAPV446	ANACRD_E_FULL_EO_PRD_SUB_M.dtsx
--To run 2 χρησιμοποιεί το ίδιο config με το run 1 κι έτσι απλά του δίνεις run, δεν χρειάζεται να πειράξεις κάτι άλλο.
--Αν η μνήμη στο pc είναι πολύ ψηλά, μπορεί κάποια να σκάνε κι απλά κάνεις rerun, αλλά καλύτερα να έχεις κλειστά τα βαριά προγράμματα.

SELECT * FROM 
--delete 
[Anacredit].[ctrl].[ETL_RUN]
WHERE REF_DT >= '2022-06-30' and RUN_STATUS = 'STARTED'




truncate table [Anacredit].[ctrl].[ETL_RUN]



--Θα πρέπει να μην υπάρχουν στο [ctrl].[ETL_RUN] εγγραφές με STARTED. Αν υπάρχουν θέλουν Delete
SELECT * FROM 
--delete 
[Anacredit].[ctrl].[ETL_RUN]
WHERE REF_DT >= '2022-06-30' and RUN_STATUS = 'STARTED'
--Πάει και δημιουργεί την A01_ANA_RUN_PHASE1, RunID 0, STARTED


DECLARE @ReportingDate DATE
DECLARE @RunID INT

SET @ReportingDate =(
SELECT [REF_DT], *
   
  FROM [Anacredit].[ctrl].[ETL_REF_DATE]
 WHERE ETL_JOB_NAME ='ANACRD_L_EDW_EDW_acc_ACC_M');
SET @RunID =(
SELECT [ETL_RUN_ID]
   
  FROM [Anacredit].[ctrl].[ETL_REF_DATE]
 WHERE ETL_JOB_NAME ='ANACRD_L_EDW_EDW_acc_ACC_M');


SELECT @ReportingDate ReportingDate, @RunID  RunID 

--SELECT @ReportingDate ReportingDate, @RunID  RunID 

select * from [ctrl].[ETL_RUN] where REF_DT	= '2021-11-31'

--prin apo ka8e run prepei na ka8arizoume alliws 8a paei ston epomeno mina
SELECT * FROM 
--delete 
[Anacredit].[ctrl].[ETL_RUN]
WHERE REF_DT >= '2022-01-31' --and RUN_STATUS = 'STARTED'
--order by REF_DT

SELECT * FROM 
--delete 
[Anacredit].[ctrl].[ETL_RUN]
WHERE REF_DT >= '2022-06-30' and RUN_STATUS = 'STARTED'

--rerun apo ANAPV294 kai katw. Piga na to dwsw me cvarRunFlag=1 all;a den to 8elei giati 8a parei run2
--otan skaei ena job prepei na sbisei to STARTED poy yparxei alliws 8a parei epomeni hm/nia
SELECT * FROM 
--delete 
[Anacredit].[ctrl].[ETL_RUN]
WHERE REF_DT >= '2022-01-31'--REF_DT = '2021-08-31' --and RUN_STATUS = 'STARTED'
and 
ETL_JOB_NAME in (
'ANACRD_T_Anacredit_STG_IFD_P8_M'
--'ANACRD_T_Anacredit_STG_CID_TMP_M'--'ANACRD_T_Anacredit_GR011_dbo_PRD_M','ANACRD_T_Anacredit_GR011_dbo_CRD_M'
)

--ANAPV110;ANACRD_T_Anacredit_STG_F_TMP_FORBORNE_M.dtsx το εκοψα στο  *****

ANAPV282;ANACRD_T_Anacredit_GR011_DBO_CRD_M.dtsx
ANAPV292;ANACRD_T_Anacredit_GR011_dbo_PRD_M.dtsx

